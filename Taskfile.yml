version: '3'

includes:
  compiler-types:
    taskfile: ./compiler-types
    aliases: [types]
    dir: ./compiler-types

  compiler-core:
    taskfile: ./compiler-core
    aliases: [core]
    dir: ./compiler-core

  compiler-wasm:
    taskfile: ./compiler-wasm
    aliases: [wasm]
    dir: ./compiler-wasm

  docs:
    taskfile: ./docs
    dir: ./docs

  web-client:
    taskfile: ./web-client
    aliases: [client, c]
    dir: ./web-client

  web-server:
    taskfile: ./web-server
    aliases: [server, s]
    dir: ./web-server

  web-themes:
    taskfile: ./web-themes
    aliases: [themes, th]
    dir: ./web-themes

  docker:
    taskfile: ./docker
    dir: ./docker

tasks:
  install:
    desc: Install development dependencies and packages
    cmds:
    - rustup update
    - cargo install cargo-watch wasm-pack regen-lang
    - cargo install cross --git https://github.com/cross-rs/cross
    - cargo install txtpp --features cli
    - task: themes:install
    - task: docs:install
    - task: client:install

  check:
    desc: Check issues in all packages
    deps: [check:ts, check:rs]

  check:ts:
    cmds:
    - task: docs:check
    - task: client:check
    - task: themes:check

  check:rs:
    deps: [core:grammar]
    cmds:
    - cargo fmt --check
    - cargo clippy --all-features --all-targets -- -D warnings -D clippy::todo

  fix:rs:
    cmds:
    - cargo fmt

  build:
    desc: Build production assets
    deps:
    - docs:build
    - build:server
    - build:client

  build:server:
    deps:
    - core:grammar
    cmds:
    - rustup default stable
    - cross build --bin celerserver --release --target x86_64-unknown-linux-musl

  build:client:
    deps:
    - themes:build
    - build:wasm
    - build:types
    cmds:
    - task: client:build

  build:wasm:
    dir: ./compiler-wasm
    deps:
    - core:grammar
    cmds:
    - cargo run --bin buildwasm --release

  build:types:
    dir: ./compiler-types
    cmds:
    - cargo run --bin buildtypes --release

